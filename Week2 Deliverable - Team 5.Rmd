---
title: "Data Prep Project Week2 Deliverable - Team 5"
output: pdf_document
---

# Research Question 

How does the density of same-category businesses within a ZIP code relate to average Yelp ratings, and does this relationship differ by business industry?

# Motivation

As cities grow and consumer activity becomes increasingly concentrated, understanding the business location landscape becomes more important. Urban economies are shaped by where businesses locate and how densely they cluster as higher density can raise demand and convenience, attracting even more firms and shaping local competitive landscapes (Kopczewska et al., 2024).

In the digital economy, platforms like Yelp play a major role in shaping consumer choices and business visibility, making online ratings an important signal of perceived quality. Business reviews have been found to not only give insights about the quality of a product or service, but have proved to be significant indicators of consumer expectations as well (Chevalier & Mayzlin, 2006). Past studies have shown that online reviews can be shaped by local competition, income levels, and demographics, all of which can vary by geography (Luca, 2011), making the location of the reviewed business highly important. However, the existence of similar businesses in the same location, referred to as “density”, can also intensify competition and raise expectations, which may change how customers evaluate their experiences. 

Furthermore, while it is undeniable that consumer behaviors are impacted by reviews, the magnitude of that impact appears to vary across industries and business types. Past research demonstrates that consumers rely more on reviews for optional services given at beauty salons or restaurants than essential services such as healthcare (Hu, Liu, & Zhang, 2008). It is, therefore, essential to consider the effect the industry of the business plays when reviews are analyzed. Given this tension, this research aims to explore: “Does the density of certain businesses within a postal code associate with higher or lower average Yelp ratings, and how does this relationship vary across business industries?”

For business owners, the findings can inform location strategy and competitive positioning by clarifying when dense clusters are likely to help or hurt evaluations across categories, supporting better benchmarking, service and pricing decisions, and more targeted expansion or franchising choices.

# Methodology 

Data exploration for this study begins with the selection of relevant columns from the yelp_academic_dataset_business.csv file, namely "state", "postal_code", "city", "review_count", "name", "categories", "stars". The columns needed for analysis are extracted from the initial database, and the data were cleaned by removing observations with missing values. The dataset was then explored using ggplot2 visualizations. Having plotted several graphs for distributions of star ratings, stars versus review count and stars versus business density by ZIP (postal code); the data is reformatted into factor variables where categories will be valuable for the research. Business labels are taken into account to determine the 20 most used business labels, and the businesses are categorized into 5 main industries accordingly. 
Once the industry classification procedure was completed, the research focused on the density of businesses within a single postal code. After the density of businesses is determined, several plots are drawn again to see how relationships change according to the industry densities by plotting each industry density against star ratings. When it is seen that the resulting figures were visually crowded, remedies are applied such as using smoothing codes together with ggplots. The study will further explore the data by separating business densities across different industries into 3 levels: low density, medium density and high density to see whether relationships will be more prominent across levels.
The research aims to use Linear Regression with Interaction Terms as the chosen method of analysis after data is explored, so that both the main relationship between the density of businesses within a postal code and Yelp ratings can be examined along with the moderating effect of industry of the business. The predicted model for the study can be seen as such: lm(rating(stars) ~ business_density + business_industry + business_density:business_category)

# Data Exploration
## Load the Dataset
```{r, message= FALSE, warning= FALSE}
# Install.packages(c("dplyr", "googledrive"))  
## Run once, not every time
library(dplyr)
library(googledrive)

# Authenticate (opens browser)
drive_auth()

# Folder ID
folder_id <- "1WHSh8ZQYzQ3IQI8tJX90cYGR4bDy13v3"

# List files in folder
files <- drive_ls(as_id(folder_id))

# Find target file
file <- files |>
  filter(name == "yelp_academic_dataset_business.csv")

# Sanity check
stopifnot(nrow(file) == 1)

# Download using file ID
drive_download(
  file,
  path = "yelp_business.csv",
  overwrite = TRUE
)

# Read data
yelp_business <- read.csv("yelp_business.csv")
```

```{r, message= FALSE, warning= FALSE}
#table(yelp_business$postal_code)
summary(yelp_business$postal_code) #Already characters don't need to change 
```

## Extract columns needed for analysis (create a new dataset)
```{r, message= FALSE, warning= FALSE}
columns = c("state","postal_code","city","review_count","name","categories","stars")
research_project <- yelp_business %>%
  select(all_of(columns))
#View(research_project) 
```

## Data cleaning (remove all NAs in postal code)
```{r, message= FALSE, warning= FALSE}
research_project_filtered <- research_project %>%
  filter(postal_code != "")
#View(research_project_filtered)
```

## Data visualization with ggplot 2 
```{r, message= FALSE, warning= FALSE}
library(ggplot2)
library(dplyr)

# Distribution of star ratings
ggplot(research_project_filtered, aes(x = stars)) +
  geom_histogram(binwidth = 0.25) +
  labs(title = "Distribution of Yelp Star Ratings",
       x = "Stars", y = "Count")

# Stars vs review count
ggplot(research_project_filtered, aes(x = review_count, y = stars)) +
  geom_point(alpha = 0.2) +
  scale_x_log10() +
  labs(title = "Stars vs Review Count",
       x = "Review Count (log scale)", y = "Stars")

# Stars vs business density by ZIP
zip_density <- research_project_filtered %>%
  count(postal_code, name = "zip_business_count")

research_project_filtered %>%
  left_join(zip_density, by = "postal_code") %>%
  ggplot(aes(x = zip_business_count, y = stars)) +
  geom_jitter(alpha = 0.2, width = 0) +
  scale_x_log10() +
  labs(title = "Business Density vs Yelp Ratings",
       x = "Businesses per ZIP (log)", y = "Stars")

```

## Dive Deeper into separate business categories
```{r, message= FALSE, warning= FALSE}
library(data.table)

setDT(research_project_filtered)
research_project_filtered[, state_categories := as.factor(state)]
research_project_filtered[,  postal_code_categories := as.factor( postal_code)]
research_project_filtered[,  city_categories := as.factor( city)]

#seeing wich category is used how many times to decide on the industry labels, checking for top 20 most used
research_project_filtered[
  , .(category = tolower(trimws(unlist(categories))))
][
  , .N, by = category
][
  order(-N)
][1:20]

#determining the top categories and turning them into 5 main categories

#cleaning categories entries and turning all lowercase
research_project_filtered[, categories_text := tolower(as.character(categories))]
research_project_filtered[, industry_categorized := "Other"]

research_project_filtered[grepl("restaurants|food|coffee|tea|mexican|italian|burgers|pizza|ice cream|yogurt|chinese",
           categories_text),
     industry_categorized := "Food & Drink"]

research_project_filtered[grepl("beauty|spa|hair|nail",
           categories_text),
     industry_categorized := "Health & Beauty"]

research_project_filtered[grepl("veterinarians|pets",
           categories_text),
     industry_categorized := "Veterinarians & Pet Shops"]

research_project_filtered[grepl("auto|automotive|repair",
           categories_text),
     industry_categorized := "Auto & Transport"]

summary(research_project_filtered)
research_project_filtered[,  industry_categorized := as.factor( industry_categorized)]
#View(research_project_filtered)
```


## Density of businesses by industry
```{r, message= FALSE, warning= FALSE}
zip_industry_density <- research_project_filtered %>%
  group_by(postal_code, industry_categorized) %>%
  summarise(
    industry_zip_count = n(),
    .groups = "drop"
  )

research_project_density <- research_project_filtered %>%
  left_join(
    zip_industry_density,
    by = c("postal_code", "industry_categorized")
  )

#View(research_project_density)
```

## Data visualization with ggplot 2 for percentage of businesses by industry
```{r, message= FALSE, warning= FALSE}
ggplot(research_project_density, aes(industry_categorized)) + geom_bar(aes(y = after_stat(count)/sum(after_stat(count))*100)) + ylab("Percentage of Businesses") + xlab("Industry Distribution") 
```

## Plotting to see if ratings are affected by business density per industry
```{r, message= FALSE, warning= FALSE}
ggplot(
  research_project_density,
  aes(x = industry_zip_count, y = stars)
) +
  geom_jitter(alpha = 0.15, width = 0) +
  scale_x_log10() +
  facet_wrap(~ industry_categorized) +
  labs(
    title = "Same-Industry Business Density vs Yelp Ratings",
    x = "Same-Industry Businesses per ZIP (log scale)",
    y = "Yelp Star Rating"
  )
```











## Smoothed Plotting: 
```{r, message= FALSE, warning= FALSE}
ggplot(
  research_project_density,
  aes(x = industry_zip_count, y = stars)
) +
  geom_jitter(alpha = 0.1, width = 0) +
  geom_smooth(method = "loess", se = FALSE) +
  scale_x_log10() +
  facet_wrap(~ industry_categorized) +
  labs(
    title = "Smoothed Relationship Between Density and Ratings by Industry",
    x = "Same-Industry ZIP Density (log)",
    y = "Average Yelp Rating"
  )

```


